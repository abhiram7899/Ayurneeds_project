<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="nav.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Portal | Ayurneeds</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .logo { font-size: 24px; font-weight: bold; color: #2c3e50; text-align: center; margin-bottom: 20px; }
        h3 { text-align: center; color: #34495e; margin-top: 0; }
        input[type="text"], input[type="file"] { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .dropdown-check-list { display: inline-block; width: 100%; position: relative; }
        .dropdown-check-list .anchor { position: relative; cursor: pointer; display: block; padding: 12px; border: 1px solid #ddd; border-radius: 5px; background: white; text-align: left; color: #555; }
        .dropdown-check-list .anchor:after { position: absolute; content: ""; border-left: 2px solid black; border-top: 2px solid black; padding: 4px; right: 15px; top: 30%; transform: rotate(-135deg); transition: 0.3s; }
        .dropdown-check-list.visible .anchor:after { transform: rotate(45deg); top: 40%; }
        .dropdown-check-list ul.items { padding: 0; display: none; margin: 5px 0 0 0; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: scroll; background: #fff; position: absolute; width: 100%; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .dropdown-check-list ul.items li { list-style: none; padding: 10px; border-bottom: 1px solid #eee; }
        .dropdown-check-list ul.items li:hover { background: #f9f9f9; }
        .dropdown-check-list.visible ul.items { display: block; }
        .or-divider { margin: 20px 0; font-weight: bold; color: #999; text-align: center; position: relative; }
        .or-divider:before, .or-divider:after { content: ""; height: 1px; background: #ddd; position: absolute; top: 50%; width: 40%; }
        .or-divider:before { left: 0; }
        .or-divider:after { right: 0; }
        button { width: 100%; padding: 15px; background: #27ae60; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #219150; }
        .status { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
        .loading { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; display: block; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">
        <img src="images/logo.png" alt="Ayurneeds Logo"></a>
        <div class="nav-links">
            <a href="index.html" class="nav-btn">Home</a>
            <a href="store.html" class="nav-btn">Store</a>
            <a href="about.html" class="nav-btn">About</a>
            <a href="contact.html" class="nav-btn">Contact</a>
            <a href="admin.html" class="nav-btn nav-primary">Admin Login</a>
        </div>
    </header>

    <div class="container">
        <div class="logo">üåø Ayurneeds</div>
        <h3>üë®‚Äç‚öïÔ∏è Doctor Portal</h3>
        <p id="verifyStatus" style="color: green; text-align: center; font-size: 14px;">‚úÖ Secure Link Verified</p>

        <label style="font-weight:600; display:block; margin-bottom:5px;">Patient Phone Number:</label>
        <input type="text" id="patientPhone" placeholder="e.g. 9876543210">

        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px dashed #ccc; margin-top: 15px;">
            <h4 style="margin-top:0;">üì∏ Option A: Upload Prescription</h4>
            <input type="file" id="rxImage" accept="image/*" style="margin-bottom:0;">
        </div>

        <div class="or-divider">OR</div>

        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px dashed #ccc;">
            <h4 style="margin-top:0;">üíä Option B: Select Medicines</h4>
            <div id="list1" class="dropdown-check-list" tabindex="100">
                <span class="anchor" onclick="toggleDropdown()">Select from Inventory...</span>
                <ul class="items" id="medicineCheckboxes">
                    <li style="color:#888; text-align:center;">Loading Stock...</li>
                </ul>
            </div>
        </div>

        <button onclick="submitPrescription()" style="margin-top: 30px;">üöÄ Submit Prescription</button>

        <div id="statusMessage" class="status"></div>
    </div>

    <script>
        // ‚úÖ Live Render Backend URL
        const API_URL = "https://ayurneeds-project.vercel.app/";

        const urlParams = new URLSearchParams(window.location.search);
        const doctorUuid = urlParams.get('id');

        if (!doctorUuid) {
            document.body.innerHTML = "<h2 style='text-align:center; color:red; margin-top:50px;'>üö´ Invalid Access Link</h2><p style='text-align:center;'>Please use the link provided by Admin.</p>";
        }

        async function loadMedicines() {
            try {
                const res = await fetch(`${API_URL}/doctor/medicine-list`);
                const meds = await res.json();
                
                const listContainer = document.getElementById('medicineCheckboxes');
                listContainer.innerHTML = ""; 

                if(meds.length === 0) {
                    listContainer.innerHTML = "<li style='color:red;'>No medicines found in Pharmacy Network.</li>";
                    return;
                }

                meds.forEach(med => {
                    const li = document.createElement("li");
                    li.innerHTML = `<label style="cursor:pointer; display:block;"><input type="checkbox" value="${med}" class="med-checkbox"> ${med}</label>`;
                    listContainer.appendChild(li);
                });
            } catch (e) {
                console.error("Could not load medicines", e);
                document.getElementById('medicineCheckboxes').innerHTML = "<li style='color:red;'>Error connecting to server.</li>";
            }
        }
        
        loadMedicines(); 

        function toggleDropdown() {
            const checkList = document.getElementById('list1');
            if (checkList.classList.contains('visible'))
                checkList.classList.remove('visible');
            else
                checkList.classList.add('visible');
        }

        document.addEventListener('click', function(e) {
            const checkList = document.getElementById('list1');
            if (!checkList.contains(e.target)) {
                checkList.classList.remove('visible');
            }
        });

        async function submitPrescription() {
            const fileInput = document.getElementById('rxImage');
            const phone = document.getElementById('patientPhone').value;
            const status = document.getElementById('statusMessage');

            const checkboxes = document.querySelectorAll('.med-checkbox:checked');
            let manualMeds = [];
            checkboxes.forEach((checkbox) => {
                manualMeds.push(checkbox.value);
            });

            if (!phone) { alert("Please enter Patient Phone Number"); return; }
            if (fileInput.files.length === 0 && manualMeds.length === 0) {
                alert("Please either Upload an Image OR Select Medicines.");
                return;
            }

            status.innerHTML = "üöÄ Sending to Pharmacy Network...";
            status.className = "status loading";

            const formData = new FormData();
            formData.append('manual_phone', phone);
            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
            }
            formData.append('manual_medicines', JSON.stringify(manualMeds));

            try {
                const response = await fetch(`${API_URL}/upload-prescription/${doctorUuid}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    status.innerHTML = `
                        <h3>‚úÖ Success!</h3>
                        <p>Prescription Sent to Admin.</p>
                        <p>Patient will be notified on <b>${phone}</b> once approved.</p>
                    `;
                    status.className = "status success";
                    document.getElementById('patientPhone').value = "";
                    fileInput.value = "";
                    checkboxes.forEach(c => c.checked = false);
                } else {
                    status.innerHTML = `‚ùå Error: ${data.detail || "Server Rejected"}`;
                    status.className = "status error";
                }
            } catch (error) {
                status.innerHTML = "‚ùå Connection Failed. Is Backend running?";
                status.className = "status error";
            }
        }
    </script>
</body>
</html>